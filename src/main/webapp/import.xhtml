<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Admin Requests</title>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</h:head>
<h:body class="container mt-5">
    <div class="user-info-container d-flex justify-content-end align-items-center p-2 bg-light border rounded">

        <div class="d-flex align-items-center mr-3">
            <h:outputText value="Текущий пользователь: #{userBean.user.username}" styleClass="font-weight-bold mr-2"/>
            <h:outputText value="(Администратор)" styleClass="text-danger font-weight-bold"
                          rendered="#{userBean.user.role eq 'ADMIN'}"/>
        </div>

        <h:form style="margin: 0; padding: 0;">
            <h:commandLink action="#{userBean.logout}" styleClass="logout-icon">
                <span class="pi pi-sign-out"></span>
            </h:commandLink>
        </h:form>

    </div>

        <div class="container mt-4">

            <br/>

            <h:form id="importForm" name="importForm" enctype="multipart/form-data" >
                <h:inputFile id="inputFile" value="#{productBean.file}" />
                <h:commandButton id="importBtn" name="importBtn" value="Импорт" action="#{productBean.importProducts}" styleClass="btn btn-primary">
                </h:commandButton>
                <br/>
                <h:messages styleClass="text-danger" showSummary="true" showDetail="false"
                            errorStyle="color:red;"  infoStyle="color:green;" warnStyle="display:none;" fatalStyle="color:red;" />
            </h:form>

            <br/>
            <!-- История импорта -->
            <h:panelGroup id="importHistoryTable">
                <h3>История импорта</h3>
                <h:form>
                    <p:dataTable id="importTable" value="#{productBean.paginatedImportHistory}" var="import"
                                 styleClass="table table-bordered">
                        <p:column headerText="ID">
                            <h:outputText value="#{import.id}"/>
                        </p:column>
                        <p:column headerText="Пользователь">
                            <h:outputText value="#{import.username}"/>
                        </p:column>
                        <p:column headerText="Статус">
                            <h:outputText value="#{import.status}" styleClass="#{import.status eq 'SUCCESS' ? 'text-success' : 'text-danger'}"/>
                        </p:column>
                        <p:column headerText="Добавлено объектов">
                            <h:outputText value="#{import.countAdded}" rendered="#{import.status eq 'SUCCESS'}"/>
                        </p:column>
                        <p:column headerText="Дата импорта">
                            <h:outputText value="#{import.createdAt}"/>
                        </p:column>
                    </p:dataTable>

                    <!-- Пагинатор -->
                    <div class="d-flex justify-content-center mt-2">
                        <h:panelGroup id="importPaginationControls" class="text-center">
                            <h:commandButton value="Previous" action="#{productBean.previousImportPage}"
                                             disabled="#{productBean.importCurrentPage == 1}"
                                             styleClass="btn btn-dark btn-sm mx-2">
                                <f:ajax execute="@this" render="importTable importPaginationInfo importPaginationControls"/>
                            </h:commandButton>

                            <span id="importPaginationInfo" class="mx-2">
                    Page #{productBean.importCurrentPage} of #{productBean.importTotalPages}
                </span>

                            <h:commandButton value="Next" action="#{productBean.nextImportPage}"
                                             disabled="#{productBean.importCurrentPage == productBean.importTotalPages}"
                                             styleClass="btn btn-dark btn-sm mx-2">
                                <f:ajax execute="@this" render="importTable importPaginationInfo importPaginationControls"/>
                            </h:commandButton>
                        </h:panelGroup>
                    </div>
                </h:form>
            </h:panelGroup>
            <h:button value="Назад" outcome="home.xhtml" styleClass="btn btn-secondary btn-lg"/>
        </div>
    <script type="text/javascript">
        var ws = new WebSocket("ws:/localhost:8080/InfSysLab1/websocket");
        ws.onopen = function () {
            console.log("Connected to WebSocket server");
        };

        ws.onmessage = function(event) {
            console.log("Received update:", event.data);
            location.reload(); // Перезагрузить страницу или использовать AJAX для обновления таблицы

        };
        ws.onclose = function () {
            console.log("Disconnected from WebSocket server");
        };

        ws.onerror = function (error) {
            console.error("WebSocket error: " + error);
        };
    </script>
</h:body>

</html>