<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
<h:head>
   <title>Импорт Продуктов</title>
   <h:outputStylesheet>
      .container {
         max-width: 800px;
         margin: 30px auto;
         padding: 20px;
         background: #f9f9f9;
         border-radius: 10px;
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      .form-group {
         margin-bottom: 15px;
      }
      .btn-primary {
         background-color: #007bff;
         border: none;
         padding: 10px 20px;
         border-radius: 5px;
         cursor: pointer;
         color: white;
      }
      .btn-primary:hover {
         background-color: #0056b3;
      }
      .table {
         width: 100%;
         border-collapse: collapse;
         margin-top: 20px;
      }
      .table th, .table td {
         border: 1px solid #ddd;
         padding: 8px;
         text-align: left;
      }
      .table th {
         background-color: #007bff;
         color: white;
      }
      .messages {
         margin-top: 15px;
      }

      .ui-messages-info, .ui-message-info {
         color: #28a745 !important; /* Зеленый цвет для info */
         background-color: #d4edda; /* Светло-зеленый фон */
         border: 1px solid #c3e6cb;
         padding: 10px;
         border-radius: 5px;
      }

      .ui-messages-error, .ui-message-error {
         color: #dc3545 !important; /* Красный цвет для ошибок */
         background-color: #f8d7da; /* Светло-красный фон */
         border: 1px solid #f5c6cb;
         padding: 10px;
         border-radius: 5px;
      }
      .success-message {
         color: #28a745;
      }
      .text-danger {
         color: #dc3545;
      }
      .text-success {
         color: #28a745;
      }
      .pagination-controls {
         display: flex;
         justify-content: center;
         margin-top: 15px;
      }
      .btn-secondary {
         background-color: #6c757d;
         border: none;
         padding: 10px 20px;
         border-radius: 5px;
         color: white;
      }
      .btn-secondary:hover {
         background-color: #5a6268;
      }
   </h:outputStylesheet>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</h:head>
<h:body class="container mt-5">
   <div class="user-info-container d-flex justify-content-end align-items-center p-2 bg-light border rounded">

      <div class="d-flex align-items-center mr-3">
         <h:outputText value="Текущий пользователь: #{userBean.user.username}" styleClass="font-weight-bold mr-2"/>
         <h:outputText value="(Администратор)" styleClass="text-danger font-weight-bold"
                       rendered="#{userBean.user.role eq 'ADMIN'}"/>
      </div>

      <h:form style="margin: 0; padding: 0;">
         <h:commandLink action="#{userBean.logout}" styleClass="logout-icon">
            <span class="pi pi-sign-out"></span>
         </h:commandLink>
      </h:form>

   </div>
   <div class="container">
      <h2>Импорт продуктов</h2>
      <h:form id="importForm" name="importForm" enctype="multipart/form-data">
         <div class="form-group">
            <h:outputLabel for="inputFile" value="Выберите файл для импорта:" />
            <h:inputFile id="inputFile" value="#{productBean.file}" mode="simple" />
         </div>
         <h:commandButton id="importBtn" value="Импорт" action="#{productBean.importProducts}"
                          styleClass="btn-primary"/>
         <h:messages styleClass="text-danger" showSummary="true" showDetail="false"
                     errorStyle="color:red;"  infoStyle="color:green;" warnStyle="display:none;" fatalStyle="color:red;" />
      </h:form>

      <!-- История импорта -->
      <h:panelGroup id="importHistoryTable">
         <h3>История импорта</h3>
         <h:form>
            <p:dataTable id="importTable" value="#{productBean.paginatedImportHistory}" var="import"
                         styleClass="table">
               <p:column headerText="ID">
                  <f:facet name="header">ID</f:facet>
                  <h:commandLink value="#{import.id}" action="#{productBean.downloadFile(import.id)}"
                                 rendered="#{import.status eq 'SUCCESS'}">
                     <f:param name="importId" value="#{history.id}" />
                  </h:commandLink>
                  <!-- Только текст для статуса не SUCCESS -->
                  <h:outputText value="#{import.id}" rendered="#{import.status ne 'SUCCESS'}" />
               </p:column>
               <p:column headerText="Пользователь">
                  <h:outputText value="#{import.username}"/>
               </p:column>
               <p:column headerText="Статус">
                  <h:outputText value="#{import.status}" styleClass="#{import.status eq 'SUCCESS' ? 'text-success' : 'text-danger'}"/>
               </p:column>
               <p:column headerText="Добавлено объектов">
                  <h:outputText value="#{import.countAdded}" rendered="#{import.status eq 'SUCCESS'}"/>
               </p:column>
               <p:column headerText="Дата импорта">
                  <h:outputText value="#{import.createdAt}"/>
               </p:column>
            </p:dataTable>

            <!-- Пагинация -->
            <div class="pagination-controls">
               <h:panelGroup id="importPaginationControls">
                  <h:commandButton value="Previous" action="#{productBean.previousImportPage}"
                                   disabled="#{productBean.importCurrentPage == 1}"
                                   styleClass="btn-secondary">
                     <f:ajax execute="@this" render="importTable importPaginationInfo importPaginationControls"/>
                  </h:commandButton>

                  <span id="importPaginationInfo">
                            Page #{productBean.importCurrentPage} of #{productBean.importTotalPages}
                        </span>

                  <h:commandButton value="Next" action="#{productBean.nextImportPage}"
                                   disabled="#{productBean.importCurrentPage == productBean.importTotalPages}"
                                   styleClass="btn-secondary">
                     <f:ajax execute="@this" render="importTable importPaginationInfo importPaginationControls"/>
                  </h:commandButton>
               </h:panelGroup>
            </div>
         </h:form>
      </h:panelGroup>

      <h:button value="Назад" outcome="home.xhtml" styleClass="btn-secondary"/>
   </div>
</h:body>
</html>
